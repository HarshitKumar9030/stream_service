<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Player</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
    />
  </head>
  <style>
    #video-container {
      max-width: 100vw;
      max-height: 100vh;
      height: screen;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .control-bar {

      padding: 0.5rem 1rem;
      gap: 1rem;
    }

    .control-button:hover {
      color: #f87171;
    }

  </style>
  <style>
  .relative {
  position: relative !important;
  display: inline-block !important;
}

#volume-slider {
  appearance: none !important;
  width: 100px !important;
  height: 8px !important;
  background-color: transparent !important;
  cursor: pointer !important;
  position: absolute !important;
  top: -110px !important;
  left: 50% !important;
  transform: translateX(-50%) rotate(-90deg) scaleY(0) !important;
  transform-origin: 50% 50% !important;
  transition: transform 0.3s ease, opacity 0.3s ease !important;
  opacity: 0 !important;
}

#volume-slider::-webkit-slider-thumb {
  appearance: none !important;
  width: 8px !important;
  height: 8px !important;
  background-color: #f87171 !important;
  border-radius: 50% !important;
  cursor: pointer !important;
  position: relative !important;
}

#volume-slider::-moz-range-thumb {
  width: 8px !important;
  height: 8px !important;
  background-color: #f87171 !important;
  border-radius: 50% !important;
  cursor: pointer !important;
  position: relative !important;
}

#volume-slider::-webkit-slider-runnable-track {
  width: 100px !important;
  height: 8px !important;
  background-color: #4b5563 !important;
  border-radius: 5px !important;
}

#volume-slider::-moz-range-track {
  width: 100px !important;
  height: 8px !important;
  background-color: #4b5563 !important;
  border-radius: 5px !important;
}

#mute:hover +  #volume-slider,
#mute:focus + #volume-slider {
  transform: translateX(-50%) rotate(-90deg) scaleY(1) !important;
  opacity: 1 !important;
}
#mute:focus-within  #volume-slider {
  transform: translateX(-50%) rotate(-90deg) scaleY(1) !important;
  opacity: 1 !important;
}

  </style>

  <style type="text/tailwindcss">
    @layer base {
      .control-button {
        @apply text-xl !px-2 !py-1  bg-neutral-400  rounded-lg text-neutral-900 hover:text-red-500 transition-transform transform hover:scale-110 focus:outline-none;
      }
      #timestamp {
        @apply text-neutral-900 p-2 bg-neutral-400 rounded-xl;
        
    }
    }
  </style>
  <body class="bg-black min-h-screen">
    <div
      id="video-container"
      class="relative w-full flex items-center justify-center overflow-hidden group z-10"
    >
      <video id="video" class="object-cover"></video>

      <button
        id="center-play-pause"
        class="absolute inset-0 flex items-center justify-center text-6xl text-white opacity-0 group-hover:opacity-100 transition-opacity duration-300 z-30 focus:outline-none"
      >
        <i class="fas fa-play"></i>
      </button>

      <div
        class="absolute bottom-0 left-0 right-0 flex items-center justify-between control-bar transition-opacity duration-300 opacity-0 group-hover:opacity-100 z-50"
      >
        <button id="play-pause" title="Play/Pause (K)" class="control-button">
          <i class="fas fa-play"></i>
        </button>
        <button id="backward" title="Rewind 10s (J)" class="control-button">
          <i class="fas fa-undo-alt"></i>
        </button>
        <button id="forward" title="Forward 10s (L)" class="control-button">
          <i class="fas fa-redo-alt"></i>
        </button>

        <div class="flex-grow mx-4 flex items-center">
          <div id="timestamp" class="text-white sm:w-32 text-sm ml-2"></div>
          <div class="flex w-full justify-center">
            <div
              id="progress-bar"
              class="relative w-2/3 h-1 rounded-full cursor-pointer"
              style="background: linear-gradient(90deg, #3b82f6, #f87171)"
            >
              <div
                id="progress-filled"
                class="absolute left-0 top-0 h-full bg-red-500 rounded-full transition-width duration-150"
              ></div>
            </div>
          </div>
        </div>
        <div class="relative flex items-center group">
            <button id="mute" title="Mute/Unmute" class="control-button relative z-10">
              <i class="fas fa-volume-up"></i>
            </button>
            <input
              type="range"
              id="volume-slider"
              class="volume-slider absolute z-20"
              min="0"
              max="1"
              step="0.1"
              value="1"
              aria-label="Volume Control"
            />
          </div>
          

        <button
          id="quality"
          title="Change Quality"
          class="control-button relative"
        >
          <i class="fas fa-cog"></i>
        </button>
        <button id="fullscreen" title="Fullscreen (F)" class="control-button">
          <i class="fas fa-expand"></i>
        </button>
      </div>

      <div
        id="quality-options"
        class="hidden absolute right-3 bottom-20 bg-neutral-800 rounded-md p-2 shadow-md z-40"
      ></div>
    </div>
    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const videoId = urlParams.get("videoId");
      const token = urlParams.get("token");
      const apiUrl = `/api/video/stream/${videoId}`;

      fetch(apiUrl, {
        method: "GET",
        headers: {
          Authorization: `Bearer ${token}`,
        },
      })
        .then((response) => response.json())
        .then((data) => {
          const videoElement = document.getElementById("video");
          const streamUrls = data.streamUrls;
          let currentQuality = "720p";

          if (Hls.isSupported()) {
            const hls = new Hls();
            hls.loadSource(streamUrls[currentQuality]);
            hls.attachMedia(videoElement);

            hls.on(Hls.Events.MANIFEST_PARSED, function () {
              videoElement.play();
            });

            const qualityOptions = document.getElementById("quality-options");
            Object.keys(streamUrls).forEach((quality) => {
              const button = document.createElement("button");
              button.innerText = quality;
              button.classList.add(
                "text-white",
                "hover:bg-neutral-600",
                "px-2",
                "py-1",
                "rounded",
                "w-full",
                "text-sm",
                "text-left"
              );
              button.onclick = () => {
                currentQuality = quality;
                const currentTime = videoElement.currentTime;
                hls.loadSource(streamUrls[quality]);
                hls.attachMedia(videoElement);
                videoElement.currentTime = currentTime;
                qualityOptions.classList.add("hidden");
              };
              qualityOptions.appendChild(button);
            });
          } else if (
            videoElement.canPlayType("application/vnd.apple.mpegurl")
          ) {
            videoElement.src = streamUrls[currentQuality];
            videoElement.addEventListener("loadedmetadata", function () {
              videoElement.play();
            });
          }
        })
        .catch((error) => console.error("Error loading video:", error));

      const centerPlayPause = document.getElementById("center-play-pause");
      centerPlayPause.addEventListener("click", togglePlayPause);

      function togglePlayPause() {
        const video = document.getElementById("video");
        if (video.paused) {
          video.play();
          centerPlayPause.innerHTML = '<i class="fas fa-pause"></i>';
          document.getElementById("play-pause").innerHTML =
            '<i class="fas fa-pause"></i>';
        } else {
          video.pause();
          centerPlayPause.innerHTML = '<i class="fas fa-play"></i>';
          document.getElementById("play-pause").innerHTML =
            '<i class="fas fa-play"></i>';
        }
      }

      document
        .getElementById("play-pause")
        .addEventListener("click", togglePlayPause);

      document.getElementById("mute").addEventListener("click", () => {
        const video = document.getElementById("video");
        video.muted = !video.muted;
        document.getElementById("mute").innerHTML = video.muted
          ? '<i class="fas fa-volume-mute"></i>'
          : '<i class="fas fa-volume-up"></i>';
      });

      document.getElementById("fullscreen").addEventListener("click", () => {
        const videoContainer = document.getElementById("video-container");
        if (document.fullscreenElement) {
          document.exitFullscreen();
        } else {
          videoContainer.requestFullscreen();
        }
      });

      document.getElementById("quality").addEventListener("click", (event) => {
        const qualityOptions = document.getElementById("quality-options");
        qualityOptions.classList.toggle("hidden");
      });

      document.addEventListener("click", (event) => {
        const qualityOptions = document.getElementById("quality-options");
        if (
          !event.target.closest("#quality") &&
          !event.target.closest("#quality-options")
        ) {
          qualityOptions.classList.add("hidden");
        }
      });

      document.getElementById("backward").addEventListener("click", () => {
        const video = document.getElementById("video");
        video.currentTime = Math.max(0, video.currentTime - 10);
      });

      document.getElementById("forward").addEventListener("click", () => {
        const video = document.getElementById("video");
        video.currentTime = Math.min(video.duration, video.currentTime + 10);
      });
      const muteButton = document.getElementById("mute");
      const volumeSlider = document.getElementById("volume-slider");
      const videoElement = document.getElementById("video");

      // Mute/Unmute button click handler
      muteButton.addEventListener("click", () => {
        videoElement.muted = !videoElement.muted;
        muteButton.innerHTML = videoElement.muted
          ? '<i class="fas fa-volume-mute"></i>'
          : '<i class="fas fa-volume-up"></i>';
        volumeSlider.value = videoElement.muted ? 0 : videoElement.volume;
      });

      // Volume slider input handler
      volumeSlider.addEventListener("input", (e) => {
        videoElement.volume = e.target.value;
        videoElement.muted = e.target.value == 0;
        muteButton.innerHTML = videoElement.muted
          ? '<i class="fas fa-volume-mute"></i>'
          : '<i class="fas fa-volume-up"></i>';
      });

      const progress = document.getElementById("progress-bar");
      const progressFilled = document.getElementById("progress-filled");
      const timestamp = document.getElementById("timestamp");
      const formatTime = (time) => {
        const minutes = Math.floor(time / 60)
          .toString()
          .padStart(2, "0");
        const seconds = Math.floor(time % 60)
          .toString()
          .padStart(2, "0");
        return `${minutes}:${seconds}`;
      };
      document.getElementById("video").addEventListener("timeupdate", () => {
        const video = document.getElementById("video");
        const percent = (video.currentTime / video.duration) * 100;
        progressFilled.style.width = `${percent}%`;
        timestamp.textContent = `${formatTime(
          video.currentTime
        )} / ${formatTime(video.duration)}`;
      });

      progress.addEventListener("click", (e) => {
        const video = document.getElementById("video");
        const newTime = (e.offsetX / progress.offsetWidth) * video.duration;
        video.currentTime = newTime;
      });

      document.addEventListener("keydown", (e) => {
        const video = document.getElementById("video");
        switch (e.key.toLowerCase()) {
          case "k":
            document.getElementById("play-pause").click();
            break;
          case "j":
            document.getElementById("backward").click();
            break;
          case "l":
            document.getElementById("forward").click();
            break;
          case "f":
            document.getElementById("fullscreen").click();
            break;
          case "escape":
            if (document.fullscreenElement) {
              document.exitFullscreen();
            }
            break;
        }
      });
    </script>
  </body>
</html>
